<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŒ¿ å…‰åˆä½œç”¨æŒ‘æˆ°è³½ | åœ‹ä¸­ç”Ÿç‰©äº’å‹•éŠæˆ²</title>
<style>
  :root {
    --primary-color: #4CAF50;
    --secondary-color: #8BC34A;
    --accent-color: #FFC107;
    --bg-color: #f0f9f0;
    --text-color: #333;
  }
  
  body {
    font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
    background-color: var(--bg-color);
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    color: var(--text-color);
  }

  .game-container {
    background: white;
    width: 90%;
    max-width: 600px;
    border-radius: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    overflow: hidden;
    position: relative;
    padding: 20px;
    text-align: center;
  }

  /* å­¸ç”ŸåŸºæœ¬è³‡æ–™æ¬„ä½ */
  .student-info {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin-bottom: 10px;
  }

  .student-field {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .student-field label {
    font-size: 0.9rem;
    color: #555;
  }

  .student-field input {
    padding: 4px 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 0.9rem;
    max-width: 90px;
  }

  /* Header & Progress */
  header {
    margin-bottom: 20px;
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
  }

  h1 {
    color: var(--primary-color);
    margin: 0;
    font-size: 1.8rem;
  }

  .progress-bar {
    height: 10px;
    background: #eee;
    border-radius: 5px;
    margin-top: 15px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--primary-color);
    width: 0%;
    transition: width 0.5s ease;
  }

  .score-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    margin-top: 5px;
  }

  .score-board {
    font-weight: bold;
    color: #666;
  }

  /* Content Styling */
  .question-box {
    font-size: 1.2rem;
    font-weight: bold;
    margin-bottom: 25px;
    color: #2c3e50;
  }

  .grid-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }

  .option-card {
    background: #fff;
    border: 2px solid #ddd;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 1.1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .option-card:hover {
    border-color: var(--secondary-color);
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
  }

  .option-card.selected {
    border-color: var(--primary-color);
    background-color: #e8f5e9;
  }

  .option-card.correct {
    border-color: #4CAF50;
    background-color: #dcedc8;
    color: #2e7d32;
  }

  .option-card.wrong {
    border-color: #f44336;
    background-color: #ffcdd2;
    color: #c62828;
  }

  .emoji {
    font-size: 2.5rem;
    margin-bottom: 10px;
  }

  /* Buttons */
  .btn {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 12px 30px;
    font-size: 1.1rem;
    border-radius: 25px;
    cursor: pointer;
    margin-top: 30px;
    transition: background 0.3s;
  }

  .btn:hover {
    background: #388E3C;
  }
  
  .btn:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .btn-small {
    font-size: 0.9rem;
    padding: 6px 14px;
    margin-top: 0;
    border-radius: 999px;
  }

  .start-btn {
    font-size: 1.5rem;
    padding: 15px 50px;
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
  }

  /* Result Screen */
  .result-card {
    background: #fff9c4;
    padding: 20px;
    border-radius: 15px;
    margin: 20px 0;
  }

  /* Footer nav */
  .footer-nav {
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .nav-btn {
    border: none;
    background: transparent;
    color: #555;
    font-size: 0.95rem;
    cursor: pointer;
    text-decoration: none;
    padding: 8px 12px;
    border-radius: 999px;
  }

  .nav-btn:hover {
    background: #e0f2f1;
  }

  .disabled-nav {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  .screen {
    display: none;
  }

  .screen.active {
    display: block;
  }
</style>
</head>
<body>

<div class="game-container">
  <!-- å­¸ç”ŸåŸºæœ¬è³‡æ–™æ¬„ä½ -->
  <div class="student-info">
    <div class="student-field">
      <label for="classInput">ç­ç´šï¼š</label>
      <input id="classInput" type="text" placeholder="ä¾‹ï¼š701">
    </div>
    <div class="student-field">
      <label for="seatInput">åº§è™Ÿï¼š</label>
      <input id="seatInput" type="text" placeholder="ä¾‹ï¼š12">
    </div>
    <div class="student-field">
      <label for="nameInput">å§“åï¼š</label>
      <input id="nameInput" type="text" placeholder="è«‹è¼¸å…¥å§“å">
    </div>
  </div>

  <header>
    <h1>ğŸŒ¿ å…‰åˆä½œç”¨æŒ‘æˆ°è³½</h1>
    <div class="score-row">
      <div class="score-board">åˆ†æ•¸: <span id="score">0</span></div>
      <!-- åˆ†æ•¸æ—çš„æäº¤æŒ‰éˆ• -->
      <button class="btn btn-small" id="submitBtn" disabled>æäº¤ç­”æ¡ˆ</button>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progress"></div>
    </div>
  </header>

  <div id="start-screen" class="screen active">
    <div style="font-size: 4rem; margin: 20px;">ğŸ­</div>
    <h2>æ­¡è¿ä¾†åˆ°æ¤ç‰©å·¥å» ï¼</h2>
    <p>ä½ æ˜¯é€™åº§è‘‰å­å·¥å» çš„æ–°ä»»å» é•·ã€‚<br>è«‹æ­£ç¢ºé¸æ“‡åŸæ–™èˆ‡æ“ä½œæ©Ÿå™¨ï¼Œè£½é€ é¤Šåˆ†å§ï¼</p>
    <p>é©ç”¨å°è±¡ï¼šåœ‹ä¸­ä¸€å¹´ç´š (ä¸ƒå¹´ç´š)</p>
    <button class="btn start-btn" onclick="startGame()">é–‹å§‹æŒ‘æˆ°</button>
  </div>

  <div id="game-screen" class="screen">
    <div class="question-box" id="question-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
    <div class="grid-options" id="options-container"></div>
    <div id="feedback" style="margin-top: 15px; font-weight: bold; height: 24px;"></div>
    <button class="btn" id="next-btn" onclick="nextLevel()" disabled>ä¸‹ä¸€é—œ</button>
  </div>

  <div id="result-screen" class="screen">
    <h2>ğŸ† æŒ‘æˆ°å®Œæˆï¼</h2>
    <div class="result-card">
      <p style="font-size: 1.2rem;">æœ€çµ‚å¾—åˆ†</p>
      <div style="font-size: 3rem; color: var(--primary-color); font-weight: bold;" id="final-score">0</div>
      <p id="result-comment">è©•èªè¼‰å…¥ä¸­...</p>
    </div>
    <button class="btn" onclick="restartGame()">å†ç©ä¸€æ¬¡</button>
  </div>

  <!-- é å°¾å°è¦½ -->
  <div class="footer-nav">
    <a href="7.html" class="nav-btn">â† ä¸Šä¸€é </a>
    <button id="endBtn" class="nav-btn disabled-nav">èª²ç¨‹çµæŸ â†’</button>
  </div>
</div>

<script>
  // å·²å¡«å…¥ä½ çš„ Apps Script ç¶²å€ï¼ˆå°æ‡‰ photosynthesis_8 â†’ gameï¼‰
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwtIG6tnrJFwsdZlU4Z-fZC9tAzjcgF9c47jd2KoOej9iozYbi2_DGTMTNEXpfjtiE/exec';

  // éŠæˆ²è³‡æ–™åº«
  const levels = [
    {
      id: 1,
      type: 'multi', // å¤šé¸
      question: "ğŸ­ã€æ­¥é©Ÿä¸€ï¼šé€²è²¨ã€‘å…‰åˆä½œç”¨éœ€è¦å“ªäº›ã€ŒåŸæ–™ã€ï¼Ÿ(è«‹é¸ 2 é …)",
      options: [
        { id: 'o2', text: "æ°§æ°£", emoji: "ğŸ’¨" },
        { id: 'h2o', text: "æ°´", emoji: "ğŸ’§" },
        { id: 'co2', text: "äºŒæ°§åŒ–ç¢³", emoji: "ğŸŒ«ï¸" },
        { id: 'sugar', text: "è‘¡è„ç³–", emoji: "ğŸ¬" }
      ],
      correct: ['h2o', 'co2'],
      explanation: "å…‰åˆä½œç”¨çš„åŸæ–™æ˜¯æ°´(ç”±æ ¹å¸æ”¶)å’ŒäºŒæ°§åŒ–ç¢³(ç”±æ°£å­”é€²å…¥)ï¼"
    },
    {
      id: 2,
      type: 'single', // å–®é¸
      question: "âš¡ã€æ­¥é©ŸäºŒï¼šèƒ½æºã€‘å·¥å» é‹ä½œéœ€è¦å“ªç¨®èƒ½é‡ä¾†æºï¼Ÿ",
      options: [
        { id: 'wind', text: "é¢¨åŠ›", emoji: "ğŸƒ" },
        { id: 'sun', text: "å¤ªé™½å…‰", emoji: "â˜€ï¸" },
        { id: 'electric', text: "é›»åŠ›", emoji: "âš¡" },
        { id: 'heat', text: "åœ°ç†±", emoji: "ğŸ”¥" }
      ],
      correct: ['sun'],
      explanation: "å…‰åˆä½œç”¨å¿…é ˆè¦æœ‰å…‰èƒ½æ‰èƒ½é€²è¡Œå–”ï¼"
    },
    {
      id: 3,
      type: 'single',
      question: "ğŸ“ã€æ­¥é©Ÿä¸‰ï¼šåœ°é»ã€‘å…‰åˆä½œç”¨ä¸»è¦ç™¼ç”Ÿåœ¨ç´°èƒçš„å“ªå€‹æ§‹é€ ï¼Ÿ",
      options: [
        { id: 'nucleus', text: "ç´°èƒæ ¸", emoji: "ğŸ§¬" },
        { id: 'vacuole', text: "æ¶²èƒ", emoji: "ğŸ’§" },
        { id: 'chloroplast', text: "è‘‰ç¶ é«”", emoji: "ğŸŸ¢" },
        { id: 'wall', text: "ç´°èƒå£", emoji: "ğŸ§±" }
      ],
      correct: ['chloroplast'],
      explanation: "è‘‰ç¶ é«”å«æœ‰è‘‰ç¶ ç´ ï¼Œæ˜¯é€²è¡Œå…‰åˆä½œç”¨çš„å ´æ‰€ï¼"
    },
    {
      id: 4,
      type: 'multi',
      question: "ğŸ“¦ã€æ­¥é©Ÿå››ï¼šå‡ºè²¨ã€‘å…‰åˆä½œç”¨æœƒç”¢ç”Ÿå“ªäº›ã€Œç”¢ç‰©ã€ï¼Ÿ(è«‹é¸ 2 é …)",
      options: [
        { id: 'o2', text: "æ°§æ°£", emoji: "ğŸ’¨" },
        { id: 'n2', text: "æ°®æ°£", emoji: "ğŸˆ" },
        { id: 'glucose', text: "è‘¡è„ç³–", emoji: "ğŸ¬" },
        { id: 'salt', text: "é£Ÿé¹½", emoji: "ğŸ§‚" }
      ],
      correct: ['o2', 'glucose'],
      explanation: "ä¸»è¦ç”¢ç‰©æ˜¯è‘¡è„ç³–(é¤Šåˆ†)ï¼Œå‰¯ç”¢ç‰©æ˜¯æ°§æ°£(é‡‹æ”¾åˆ°ç©ºæ°£ä¸­)ã€‚"
    },
    {
      id: 5,
      type: 'single',
      question: "ğŸ§ªã€åŠ åˆ†é¡Œã€‘è¦æª¢æ¸¬è‘‰ç‰‡ä¸­æ˜¯å¦å«æœ‰æ¾±ç²‰ï¼Œæ‡‰ä½¿ç”¨ä»€éº¼è©¦åŠ‘ï¼Ÿ",
      options: [
        { id: 'iodine', text: "ç¢˜æ¶²", emoji: "ğŸŸ¤" },
        { id: 'blue', text: "æœ¬æ°æ¶²", emoji: "ğŸ”µ" },
        { id: 'alcohol', text: "é…’ç²¾", emoji: "ğŸ¶" },
        { id: 'water', text: "æ¸…æ°´", emoji: "ğŸ’§" }
      ],
      correct: ['iodine'],
      explanation: "ç¢˜æ¶²é‡åˆ°æ¾±ç²‰æœƒå¾é»ƒè¤è‰²è®Šç‚ºè—é»‘è‰²ï¼"
    }
  ];

  let currentLevelIndex = 0;
  let score = 0;
  let selectedOptions = [];
  let isLevelAnswered = false;
  let allResponses = [];   // ç´€éŒ„æ¯ä¸€é¡Œçš„ä½œç­”
  let hasSubmitted = false;

  const startScreen = document.getElementById('start-screen');
  const gameScreen = document.getElementById('game-screen');
  const resultScreen = document.getElementById('result-screen');
  const scoreEl = document.getElementById('score');
  const progressFill = document.getElementById('progress');
  const questionText = document.getElementById('question-text');
  const optionsContainer = document.getElementById('options-container');
  const nextBtn = document.getElementById('next-btn');
  const feedbackEl = document.getElementById('feedback');
  const submitBtn = document.getElementById('submitBtn');
  const endBtn = document.getElementById('endBtn');

  function startGame() {
    score = 0;
    currentLevelIndex = 0;
    selectedOptions = [];
    allResponses = [];
    hasSubmitted = false;
    scoreEl.innerText = score;

    startScreen.classList.remove('active');
    gameScreen.classList.add('active');
    resultScreen.classList.remove('active');

    submitBtn.disabled = true;
    submitBtn.innerText = 'æäº¤ç­”æ¡ˆ';
    endBtn.classList.add('disabled-nav');

    loadLevel();
  }

  function loadLevel() {
    isLevelAnswered = false;
    selectedOptions = [];
    nextBtn.innerText = "æª¢æŸ¥ç­”æ¡ˆ";
    nextBtn.disabled = true;
    feedbackEl.innerText = "";
    
    const level = levels[currentLevelIndex];
    questionText.innerText = level.question;
    
    // Update Progress
    const progress = (currentLevelIndex / levels.length) * 100;
    progressFill.style.width = `${progress}%`;

    // Generate Options
    optionsContainer.innerHTML = '';
    level.options.forEach(opt => {
      const card = document.createElement('div');
      card.className = 'option-card';
      card.innerHTML = `<div class="emoji">${opt.emoji}</div><div>${opt.text}</div>`;
      card.onclick = () => selectOption(card, opt.id, level.type);
      optionsContainer.appendChild(card);
    });
  }

  function selectOption(cardElement, optionId, type) {
    if (isLevelAnswered) return;

    if (type === 'single') {
      // Clear previous selection
      document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
      selectedOptions = [optionId];
      cardElement.classList.add('selected');
    } else {
      // Toggle selection
      if (selectedOptions.includes(optionId)) {
        selectedOptions = selectedOptions.filter(id => id !== optionId);
        cardElement.classList.remove('selected');
      } else {
        selectedOptions.push(optionId);
        cardElement.classList.add('selected');
      }
    }
    
    // Enable check button if anything is selected
    nextBtn.disabled = selectedOptions.length === 0;
  }

  function nextLevel() {
    if (!isLevelAnswered) {
      checkAnswer();
    } else {
      currentLevelIndex++;
      if (currentLevelIndex < levels.length) {
        loadLevel();
      } else {
        showResult();
      }
    }
  }

  function checkAnswer() {
    isLevelAnswered = true;
    const level = levels[currentLevelIndex];
    
    // Sort arrays to compare
    const sortedSelected = [...selectedOptions].sort();
    const sortedCorrect = [...level.correct].sort();
    const isCorrect = JSON.stringify(sortedSelected) === JSON.stringify(sortedCorrect);

    const cards = document.querySelectorAll('.option-card');

    // Visual feedback
    level.options.forEach((opt, index) => {
      const card = cards[index];
      if (level.correct.includes(opt.id)) {
        card.classList.add('correct'); // Highlight correct answer
      } else if (selectedOptions.includes(opt.id)) {
        card.classList.add('wrong'); // Highlight wrong selection
      }
    });

    // ç´€éŒ„ä½œç­”
    allResponses.push({
      levelId: level.id,
      question: level.question,
      type: level.type,
      selected: sortedSelected,
      correct: sortedCorrect,
      isCorrect: isCorrect
    });

    if (isCorrect) {
      score += 20;
      scoreEl.innerText = score;
      feedbackEl.style.color = "green";
      feedbackEl.innerText = "ğŸ‰ ç­”å°äº†ï¼ " + level.explanation;
    } else {
      feedbackEl.style.color = "red";
      feedbackEl.innerText = "âŒ ç­”éŒ¯äº†ï¼ " + level.explanation;
    }

    // Change button to "Next Level"
    nextBtn.innerText = currentLevelIndex === levels.length - 1 ? "æŸ¥çœ‹æˆç¸¾" : "ä¸‹ä¸€é—œ";
  }

  function showResult() {
    gameScreen.classList.remove('active');
    resultScreen.classList.add('active');
    progressFill.style.width = '100%';
    
    const finalScoreEl = document.getElementById('final-score');
    const commentEl = document.getElementById('result-comment');
    
    // Count up animation
    let tempScore = 0;
    const interval = setInterval(() => {
      tempScore += 1;
      finalScoreEl.innerText = tempScore;
      if (tempScore >= score) clearInterval(interval);
    }, 20);

    if (score === 100) {
      commentEl.innerText = "ğŸŒŸ å¤ªå¼·äº†ï¼ä½ æ˜¯å…‰åˆä½œç”¨å¤§å¸«ï¼";
    } else if (score >= 60) {
      commentEl.innerText = "ğŸ‘ å¾ˆä¸éŒ¯ï¼é€™åº§å·¥å» é‹ä½œé †åˆ©ï¼";
    } else {
      commentEl.innerText = "ğŸ’ª åŠ æ²¹ï¼å†è¤‡ç¿’ä¸€ä¸‹èª²æœ¬å§ï¼";
    }

    // éŠæˆ²çµæŸå¾Œï¼Œæ‰å…è¨±æäº¤ç­”æ¡ˆ
    submitBtn.disabled = false;
  }

  function restartGame() {
    resultScreen.classList.remove('active');
    startScreen.classList.add('active');
  }

  async function submitAnswers() {
    if (submitBtn.disabled) return;

    if (hasSubmitted) {
      alert('ä½ å·²ç¶“æäº¤éæˆç¸¾å›‰ï¼');
      return;
    }

    const classValue = document.getElementById('classInput').value.trim();
    const seatValue = document.getElementById('seatInput').value.trim();
    const nameValue = document.getElementById('nameInput').value.trim();

    if (!classValue || !seatValue || !nameValue) {
      alert('è«‹å…ˆå¡«å¯«ã€Œç­ç´šã€åº§è™Ÿã€å§“åã€å†æäº¤ã€‚');
      return;
    }

    if (!resultScreen.classList.contains('active')) {
      alert('è«‹å…ˆå®Œæˆæ‰€æœ‰é—œå¡ä¸¦æŸ¥çœ‹æˆç¸¾ï¼Œå†æäº¤ç­”æ¡ˆã€‚');
      return;
    }

    const payload = {
      class: classValue,
      seat: seatValue,
      name: nameValue,
      score: score,
      responses: allResponses,
      page: '8.html',
      timestamp: new Date().toISOString()
    };

    try {
      submitBtn.disabled = true;
      submitBtn.innerText = 'é€å‡ºä¸­...';

      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(() => ({}));

      if (res.ok && data.status === 'success') {
        alert('âœ… æˆç¸¾å·²æˆåŠŸé€å‡ºï¼');
        hasSubmitted = true;
        submitBtn.innerText = 'å·²æäº¤';
        // è§£é–ã€Œèª²ç¨‹çµæŸã€æŒ‰éˆ•
        endBtn.classList.remove('disabled-nav');
      } else {
        alert('é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚');
        submitBtn.disabled = false;
        submitBtn.innerText = 'æäº¤ç­”æ¡ˆ';
      }
    } catch (err) {
      console.error(err);
      alert('é€å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚');
      submitBtn.disabled = false;
      submitBtn.innerText = 'æäº¤ç­”æ¡ˆ';
    }
  }

  // ç¶å®šæŒ‰éˆ•äº‹ä»¶
  submitBtn.addEventListener('click', submitAnswers);
  endBtn.addEventListener('click', () => {
    if (!endBtn.classList.contains('disabled-nav')) {
      window.location.href = './index.html';
    }
  });
</script>

</body>
</html>
